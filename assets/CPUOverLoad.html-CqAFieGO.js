import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as n,e}from"./app-xHrnIhLr.js";const o={},p=e(`<h3 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题</span></a></h3><blockquote><p>某天突然收到预警邮件，服务器CPU超过阈值，并且一直持续居高不下</p></blockquote><h3 id="分析原因" tabindex="-1"><a class="header-anchor" href="#分析原因"><span>分析原因</span></a></h3><ol><li>使用<code>htop</code>查看资源消耗，按照CPU使用率降序排列，发现都是mysqld进程占用CPU很高</li><li>进入mysql命令行使用<code>show processlist;</code>查看当前正在执行的命令，经过多次执行<code>show processlist</code>发现有几条固定的sql一直在执行，并且每次传递的参数害不一样</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show processlist<span class="token punctuation">;</span>
+--------+------+-------------------+--------------------------+---------+------+--------------+-----------------------------------------------------------------------------------------------+
<span class="token operator">|</span> Id     <span class="token operator">|</span> User <span class="token operator">|</span> Host              <span class="token operator">|</span> db                       <span class="token operator">|</span> Command <span class="token operator">|</span> Time <span class="token operator">|</span> State        <span class="token operator">|</span> Info                                                                                          <span class="token operator">|</span>
+--------+------+-------------------+--------------------------+---------+------+--------------+-----------------------------------------------------------------------------------------------+
<span class="token operator">|</span> <span class="token number">130878</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:43314   <span class="token operator">|</span> bomconfig                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">77</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">132762</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:34342   <span class="token operator">|</span> ccsx_weibao              <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Sending data <span class="token operator">|</span> SELECT vir.*, <span class="token number">1</span> as business_type
                FROM ccsx_data.v_install_record vir
                WHERE vir.id <span class="token operator">=</span> <span class="token number">1948</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">132841</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:42218   <span class="token operator">|</span> ccsx                     <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">574</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">132955</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:54332   <span class="token operator">|</span> ccsx                     <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">693</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133058</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:38132   <span class="token operator">|</span> bomconfig                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">434</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133243</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:58272   <span class="token operator">|</span> ccsx_data                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">539</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133347</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:41100   <span class="token operator">|</span> ccsx_weibao              <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Sending data <span class="token operator">|</span> <span class="token keyword">select</span> * from ccsx_weibao.install_record_accessory where <span class="token assign-left variable">host_id</span><span class="token operator">=</span><span class="token number">2106</span>                         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133416</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:47832   <span class="token operator">|</span> international_ccsx_data  <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">519</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133454</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:51226   <span class="token operator">|</span> internatinal_ccsx_weibao <span class="token operator">|</span> Sleep   <span class="token operator">|</span> <span class="token number">1194</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133459</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:51642   <span class="token operator">|</span> ccsx                     <span class="token operator">|</span> Sleep   <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133466</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:51956   <span class="token operator">|</span> bomconfig                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">488</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133467</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:51958   <span class="token operator">|</span> bomconfig                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>   <span class="token number">77</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133469</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:52616   <span class="token operator">|</span> ccsx_data                <span class="token operator">|</span> Sleep   <span class="token operator">|</span>  <span class="token number">540</span> <span class="token operator">|</span>              <span class="token operator">|</span> NULL                                                                                          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">133519</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost:57874   <span class="token operator">|</span> ccsx_weibao              <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Sending data <span class="token operator">|</span> SELECT vir.*, <span class="token number">1</span> as business_type
                FROM ccsx_data.v_install_record vir
                WHERE vir.id <span class="token operator">=</span> <span class="token number">19042</span> <span class="token operator">|</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经过第2步的执行，猜测有人在for循环中调用了查询，每次传递了不同的参数</p><ol start="3"><li><p>为了确定我的分析正确性，复制<code>show processlist</code>结果中的sql，到项目代码查询，最终跟踪到如下代码，确实在循环中使用了查询，fuck！</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstallRecordVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInstalls</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstallRecordVO</span><span class="token punctuation">&gt;</span></span> installRecords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			ids<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
				<span class="token class-name">InstallRecordVO</span> installRecordVO <span class="token operator">=</span> installRecordMapper<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>installRecordVO<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstallRecordAccessory</span><span class="token punctuation">&gt;</span></span> installRecordAccessories <span class="token operator">=</span> installRecordAccessoryMapper<span class="token punctuation">.</span><span class="token function">queryByHostId</span><span class="token punctuation">(</span>installRecordVO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//……省略部分代码</span>
					<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysFile</span><span class="token punctuation">&gt;</span></span> sysFileList <span class="token operator">=</span> sysFileMapper<span class="token punctuation">.</span><span class="token function">queryByBusinessInfo</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//……省略部分代码</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> installRecords<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>光有以上代码还不能完全确定，这个循环在线上一直在执行，所以我决定使用arthas来进一步确定，于是我把arths attach到生产环境的项目上使用<code>trace</code>分别跟踪循环中的三个查询，看看是否正在执行，结果三个全在执行，印证了循环一直在执行，所以cpu问题就出现在这里了。</p></li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>trace com.sonoscape.ccs.data.mapper.InstallRecordMapper queryById  <span class="token parameter variable">-n</span> <span class="token number">5</span> <span class="token parameter variable">--skipJDKMethod</span> <span class="token boolean">false</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>trace com.sonoscape.ccs.data.mapper.InstallRecordAccessoryMapper queryByHostId  <span class="token parameter variable">-n</span> <span class="token number">5</span> <span class="token parameter variable">--skipJDKMethod</span> <span class="token boolean">false</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>trace com.sonoscape.ccs.data.mapper.SysFileMapper queryByBusinessInfo  <span class="token parameter variable">-n</span> <span class="token number">5</span> <span class="token parameter variable">--skipJDKMethod</span> <span class="token boolean">false</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>最后我找到这部分代码负责人，他的ids参数本应该是个过滤后的，理论上不会太多，结果因为调用函数不严谨导致查询出ids实际上是全表的，吐</li></ol><h3 id="结论" tabindex="-1"><a class="header-anchor" href="#结论"><span>结论</span></a></h3><p>不要轻易在循环执行sql</p>`,13),t=[p];function l(c,r){return a(),n("div",null,t)}const d=s(o,[["render",l],["__file","CPUOverLoad.html.vue"]]),u=JSON.parse('{"path":"/other/database/CPUOverLoad.html","title":"Mysql CPU负载过高","lang":"zh-CN","frontmatter":{"title":"Mysql CPU负载过高","date":"2022-07-20T00:00:00.000Z","author":"chenkun","publish":true,"keys":null,"category":["数据库"],"description":"问题 某天突然收到预警邮件，服务器CPU超过阈值，并且一直持续居高不下 分析原因 使用htop查看资源消耗，按照CPU使用率降序排列，发现都是mysqld进程占用CPU很高 进入mysql命令行使用show processlist;查看当前正在执行的命令，经过多次执行show processlist发现有几条固定的sql一直在执行，并且每次传递的参数害...","head":[["meta",{"property":"og:url","content":"https://ChenSino.github.io/other/database/CPUOverLoad.html"}],["meta",{"property":"og:site_name","content":"ChenSino"}],["meta",{"property":"og:title","content":"Mysql CPU负载过高"}],["meta",{"property":"og:description","content":"问题 某天突然收到预警邮件，服务器CPU超过阈值，并且一直持续居高不下 分析原因 使用htop查看资源消耗，按照CPU使用率降序排列，发现都是mysqld进程占用CPU很高 进入mysql命令行使用show processlist;查看当前正在执行的命令，经过多次执行show processlist发现有几条固定的sql一直在执行，并且每次传递的参数害..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2022-08-01T13:56:59.000Z"}],["meta",{"property":"article:author","content":"chenkun"}],["meta",{"property":"article:published_time","content":"2022-07-20T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2022-08-01T13:56:59.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Mysql CPU负载过高\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-07-20T00:00:00.000Z\\",\\"dateModified\\":\\"2022-08-01T13:56:59.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"chenkun\\"}]}"]]},"headers":[{"level":3,"title":"问题","slug":"问题","link":"#问题","children":[]},{"level":3,"title":"分析原因","slug":"分析原因","link":"#分析原因","children":[]},{"level":3,"title":"结论","slug":"结论","link":"#结论","children":[]}],"git":{"createdTime":1659362219000,"updatedTime":1659362219000,"contributors":[{"name":"chenkun","email":"462488588@qq.com","commits":1}]},"readingTime":{"minutes":2.12,"words":636},"filePathRelative":"other/database/CPUOverLoad.md","localizedDate":"2022年7月20日","excerpt":"<!-- more-->\\n<h3>问题</h3>\\n<blockquote>\\n<p>某天突然收到预警邮件，服务器CPU超过阈值，并且一直持续居高不下</p>\\n</blockquote>\\n<h3>分析原因</h3>\\n<ol>\\n<li>使用<code>htop</code>查看资源消耗，按照CPU使用率降序排列，发现都是mysqld进程占用CPU很高</li>\\n<li>进入mysql命令行使用<code>show processlist;</code>查看当前正在执行的命令，经过多次执行<code>show processlist</code>发现有几条固定的sql一直在执行，并且每次传递的参数害不一样</li>\\n</ol>","autoDesc":true}');export{d as comp,u as data};
