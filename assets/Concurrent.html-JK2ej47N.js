import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,e as t}from"./app-xHrnIhLr.js";const p={},o=t(`<h2 id="_1、背景" tabindex="-1"><a class="header-anchor" href="#_1、背景"><span>1、背景</span></a></h2><p>因没做过大项目，并发经验匮乏，所以很多时候考虑不到并发问题，今天做接口的压力测试，无意间发现一个并发的问题，就是判断数据库是否存在某个记录时，如果没做并发处理，就会出现并发的问题，比如以下代码，给某个医院添加科室，当医院已经有这个科室则不允许重复添加重名的科室</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addHospitalDept</span><span class="token punctuation">(</span><span class="token class-name">SysHospitalDept</span> sysHospitalDept<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据医院id,科室名，校验科室唯一性</span>
        <span class="token class-name">SysHospitalDept</span> hospitalDept <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryByHospitalIdAndDeptName</span><span class="token punctuation">(</span>sysHospitalDept<span class="token punctuation">.</span><span class="token function">getHospitalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sysHospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>hospitalDept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;医院id：{}，已经存在了科室[{}]&quot;</span><span class="token punctuation">,</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getHospitalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;该医院下已经存在了科室——&quot;</span> <span class="token operator">+</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setDelFlag</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setCreatorId</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysHospitalDept<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码表面看没啥问题，实际上存在并发问题，当同时进来大量请求访问此接口，则很容易复现并发问题，在最后一行<code>this.save(sysHospitalDept);</code>执行完成前，queryByHospitalIdAndDeptName一直返回的null,就会导致很多线程在if判断时都得到的是一个null对象，不会抛出异常，所以就会重复添加。</p><h2 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法"><span>解决方法</span></a></h2><p>使用同步代码解决：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addHospitalDept</span><span class="token punctuation">(</span><span class="token class-name">SysHospitalDept</span> sysHospitalDept<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//根据医院id,科室名，校验科室唯一性</span>
			<span class="token class-name">SysHospitalDept</span> hospitalDept <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryByHospitalIdAndDeptName</span><span class="token punctuation">(</span>sysHospitalDept<span class="token punctuation">.</span><span class="token function">getHospitalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sysHospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>hospitalDept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;医院id：{}，已经存在了科室[{}]&quot;</span><span class="token punctuation">,</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getHospitalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;该医院下已经存在了科室——&quot;</span> <span class="token operator">+</span> hospitalDept<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setDelFlag</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setCreatorId</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sysHospitalDept<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysHospitalDept<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>这种并发问题是因为使用了第三方数据库中的东西来作为判断条件，这有点分布式的感觉，因为数据是放在第三方，不是在本地程序，第三方数据是可能随时被别人修改的。这种情况一定要注意并发问题。</p>`,9),e=[o];function c(l,u){return s(),a("div",null,e)}const r=n(p,[["render",c],["__file","Concurrent.html.vue"]]),d=JSON.parse('{"path":"/java/advance/Concurrent.html","title":"并发问题","lang":"zh-CN","frontmatter":{"title":"并发问题","date":"2023-02-17T00:00:00.000Z","isOriginal":true,"tag":"-- 并发","description":"1、背景 因没做过大项目，并发经验匮乏，所以很多时候考虑不到并发问题，今天做接口的压力测试，无意间发现一个并发的问题，就是判断数据库是否存在某个记录时，如果没做并发处理，就会出现并发的问题，比如以下代码，给某个医院添加科室，当医院已经有这个科室则不允许重复添加重名的科室 以上代码表面看没啥问题，实际上存在并发问题，当同时进来大量请求访问此接口，则很容易...","head":[["meta",{"property":"og:url","content":"https://ChenSino.github.io/java/advance/Concurrent.html"}],["meta",{"property":"og:site_name","content":"ChenSino"}],["meta",{"property":"og:title","content":"并发问题"}],["meta",{"property":"og:description","content":"1、背景 因没做过大项目，并发经验匮乏，所以很多时候考虑不到并发问题，今天做接口的压力测试，无意间发现一个并发的问题，就是判断数据库是否存在某个记录时，如果没做并发处理，就会出现并发的问题，比如以下代码，给某个医院添加科室，当医院已经有这个科室则不允许重复添加重名的科室 以上代码表面看没啥问题，实际上存在并发问题，当同时进来大量请求访问此接口，则很容易..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-03-22T03:45:12.000Z"}],["meta",{"property":"article:author","content":"ChenSino"}],["meta",{"property":"article:tag","content":"-- 并发"}],["meta",{"property":"article:published_time","content":"2023-02-17T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-03-22T03:45:12.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"并发问题\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-02-17T00:00:00.000Z\\",\\"dateModified\\":\\"2024-03-22T03:45:12.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"ChenSino\\",\\"url\\":\\"https://ChenSino.github.io\\"}]}"]]},"headers":[{"level":2,"title":"1、背景","slug":"_1、背景","link":"#_1、背景","children":[]},{"level":2,"title":"解决方法","slug":"解决方法","link":"#解决方法","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1676623349000,"updatedTime":1711079112000,"contributors":[{"name":"ChenSino","email":"462488588@qq.com","commits":1},{"name":"chenxk","email":"chenxk@sonoscape.net","commits":1}]},"readingTime":{"minutes":1.57,"words":471},"filePathRelative":"java/advance/Concurrent.md","localizedDate":"2023年2月17日","excerpt":"<h2>1、背景</h2>\\n<p>因没做过大项目，并发经验匮乏，所以很多时候考虑不到并发问题，今天做接口的压力测试，无意间发现一个并发的问题，就是判断数据库是否存在某个记录时，如果没做并发处理，就会出现并发的问题，比如以下代码，给某个医院添加科室，当医院已经有这个科室则不允许重复添加重名的科室</p>\\n<div class=\\"language-java\\" data-ext=\\"java\\" data-title=\\"java\\"><pre class=\\"language-java\\"><code><span class=\\"token keyword\\">public</span> <span class=\\"token keyword\\">void</span> <span class=\\"token function\\">addHospitalDept</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">SysHospitalDept</span> sysHospitalDept<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token comment\\">//根据医院id,科室名，校验科室唯一性</span>\\n        <span class=\\"token class-name\\">SysHospitalDept</span> hospitalDept <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">this</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">queryByHospitalIdAndDeptName</span><span class=\\"token punctuation\\">(</span>sysHospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getHospitalId</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> sysHospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getDeptName</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">Objects</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">nonNull</span><span class=\\"token punctuation\\">(</span>hospitalDept<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            log<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">error</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"医院id：{}，已经存在了科室[{}]\\"</span><span class=\\"token punctuation\\">,</span> hospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getHospitalId</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> hospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getDeptName</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n            <span class=\\"token keyword\\">throw</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">RuntimeException</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"该医院下已经存在了科室——\\"</span> <span class=\\"token operator\\">+</span> hospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getDeptName</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\t\\tsysHospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setDelFlag</span><span class=\\"token punctuation\\">(</span><span class=\\"token boolean\\">false</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\t\\tsysHospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setCreatorId</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">SecurityUtils</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getUser</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getId</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\t\\tsysHospitalDept<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setCreateTime</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">LocalDateTime</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">now</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\t\\t<span class=\\"token keyword\\">this</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">save</span><span class=\\"token punctuation\\">(</span>sysHospitalDept<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\t<span class=\\"token punctuation\\">}</span>\\n</code></pre></div>","autoDesc":true}');export{r as comp,d as data};
